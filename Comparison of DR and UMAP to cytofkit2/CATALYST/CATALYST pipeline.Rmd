---
title: "Spectral test analysis"
subtitle: "Prelim analysis"
author: "Jonatan Leffler"
date:  '`r format(Sys.Date(), "%d-%B-%Y")`'
output: 
  prettydoc::html_pretty: 
    theme: cayman
    #highlight: vignette
    toc: true
toc-title: "Table of Contents"
editor_options: 
  chunk_output_type: console
---

## Load libraries

```{r, message=FALSE, warning=FALSE}
library(flowCore)
library(flowViz)
library(SummarizedExperiment)
library(ggcyto)
library(diffcyt)
library(CATALYST)
library(SingleCellExperiment)
library(scater)
library(flowStats)
```

## Set working directory

```{r}
setwd("W:/Collaborative Projects/BSNRF/Spectre/Comparison of DR and UMAP to cytofkit2/CATALYST")
```

## Read in data

Load fcs files into flowSet (all fcs-files should be in a Folder called "Flowdata")
In this step, we do not transform the data but we do remove events that are outside the max_range

```{r}
fs <-read.flowSet(path="FCS files", pattern=".fcs", transformation=F, truncate_max_range=F)
```


## Exp  lore the flowdata loaded into the flowset (fs)

Get a summary of the fs and also exemplify by looking at data from the first file
```{r}
fs
summary(fs[1])
```


View and write parameters of flowset so make sure what parameters that have been imported, these will be used to create a "panel" annotation

```{r}
colnames(fs)
write.csv(colnames(fs),file="colnames.csv")
```


The panel is annotated in a csv file, where "fcs_colname"	"antigen"	"marker_class" makes up the three columns needed. "marker_class" is either "state" ir "type" depending on if parameter should be included in clustering or not

#read in the panel information

```{r}

panel <-read.csv("panel.csv", header=T)
head(data.frame(panel))
```


export file names in fs to create a new clinical data table to be called "md.csv", this should be constructed with at least the following columns: "file", "sample_id", "condition", more parameters can be included. 

```{r}
write.csv(sampleNames(fs), file="sample_names.csv")
```

#read in the experimental conditions


```{r}
md <-read.csv("md.csv", header=T)
head(data.frame(md))
```


#checking all colnames in panel are represented in colnames in the FlowSet
```{r}
all(panel$fcs_colname %in% colnames(fs))
```

#generate sce
Generating "sce" with multiple experimental conditions as defined in the md csv file

```{r}
sce<-prepData(fs, panel, md, transform=F, cofactor=6, FACS=T, md_cols=list(file="file", id="sample_id", factors=c("condition",	"batch")))

metadata(sce)$experiment_info

# Rename one of the duplicates to "exprs"
names(sce@assays@data@listData)[names(sce@assays@data@listData) == "counts"] <- "exprs"
```

Check for spread across samples using a MDS plot
```{r}
pbMDS(sce, color_by="condition", label_by="sample_id")
pbMDS(sce, color_by="batch", label_by="sample_id")


```

```{r, echo=F, eval=F}
png(file="MDS plot_batch.png", width=800, height=600)
pbMDS(sce, color_by="condition", label_by="sample_id") +labs(title="MDS plot of variability per condition")
dev.off()
```


Generate FlowSOM clusters
Start with using a 10x10 dim

```{r}
sce<-cluster(sce, features="type", xdim=10, ydim=10, maxK=12, verbose=F, seed=123) #seed is set here for reproducibility, can experiment with several different ones to check robustness of clustering

delta_area(sce) ##see how many natural occuring metaclusters sits, i.e where curve starts flattening, in this case, we have set it to 12 metaclusters but based on figure, we could likely use 11 metaclusters..however, it is always better to overestimate metacluster and manually merge them to not miss rare subsets
```


time for UMAP
```{r}
set.seed(123)
sce<-runDR(sce,dr="UMAP", cell=10000, features="type")
plotDR(sce,color_by="meta12")
plotDR(sce,color_by="sample_id")
plotDR(sce,color_by="condition", facet_by="condition")
```


```{r, echo=F, eval=F}
saveRDS(sce,file="cluster and UMAP_MS spectral downsampled.rds")
```

Now it is time to annotate the clusters, plot all expression markers used to create the clusters i.e. "type" markers

```{r}

## try mapping expression of markers in UMAP all together ##

plotDR(sce, color_by=c("CD45RB", "CD79b", "CD71", "CD38", "CXCR5", "HLA-DR", "CD24", "CD19", "CD21", "IgA", "IgG2_IgG3", "IgM", "IgG", "IgG1_IgG3", "IgD", "CD20", "BAFF-R", "CD11c", "CD27",  "CD86", "CD10", "CXCR3"), ncol=8) + theme(strip.text=element_text(angle=0, size=14, face="plain"))
  
## code getting grumpy, split markers into two lines, below is the second set of plots##

plotDR(sce, color_by=c("CD45RB", "CD79b", "CD71", "CD38", "CXCR5", "HLA-DR"), ncol=8) + theme(strip.text=element_text(angle=0, size=8, face="plain"))

plotDR(sce, color_by=c("CD24", "EBNA-1 BUV737", "CD19", "EBNA-1 BV421", "CD21", "CD20"), ncol=8) + theme(strip.text=element_text(angle=0, size=8, face="plain"))
                
plotDR(sce, color_by=c("BAFF-R", "CD11c", "IgG", "CD27", "IgG1_IgG3", "IgG2+IgG3"), ncol=8) + theme(strip.text=element_text(angle=0, size=8, face="plain"))

plotDR(sce, color_by=c("CD86", "CD10", "IgD", "CXCR3", "CXCR5", "IgA", "IgM"), ncol=8) + theme(strip.text=element_text(angle=0, size=8, face="plain"))


```

```{r, echo=F, eval=F}
saveRDS(sce,file="cluster and UMAP with markers_MS spectral downsampled.rds")
```
Save as png as well
```{r, echo=F, eval=F}
png(file="UMAP expression markers 1.png", width=1800, height=1200)
plotDR(sce, color_by=c("CD45RB", "CD79b", "IgA", "CD71", "IgG2_IgG3", "IgM", "CD38", "CXCR5", "HLA-DR", "CD24", "CD19", "CD21"), ncol=8) + theme(strip.text=element_text(angle=0, size=14, face="plain"))
                       
png(file="UMAP expression markers 2.png", width=1800, height=1200)                       
plotDR(sce, color_by=c("CD20", "BAFF-R", "CD11c", "IgG", "CD27", "IgG1_IgG3", "CD86", "CD10", "IgD", "CXCR3"), ncol=8) + theme(strip.text=element_text(angle=0, size=14, face="plain"))

dev.off()
```

```{r}
pdf(file="UMAP expression markers.pdf", width=1000, height=800)
plotDR(sce, color_by=c(""), ncol=8) + theme(strip.text=element_text(angle=0, size=14, face="plain"))
dev.off()

pdf(file="UMAP merging5.pdf", width=40, height=40)
plotDR(sce, color_by="merging5") + theme(strip.text=element_text(angle=0, size=14, face="plain"))
dev.off()
```


Time to annotate the clusters, 
```{r, eval=F}
#to identify what clusters deifinitions can be improved, first export the cluster codes
write.csv(metadata(sce)$cluster_codes, file="cluster_codes.csv") #rename this to "merging_table" before re-importing into R

#import new merging clusters, manually annotated
merging_table <-read.csv("merging_table.csv", header=T)
sce<-mergeClusters(sce, k="som100", table=merging_table, id="B_cell_subsets")
plotDR(sce, color_by="B_cell_subsets")



saveRDS(sce,file="cluster and UMAP.rds")
#happy!

```

```{r For further som based detailing, eval=FALSE, include=FALSE}
u<-filterSCE(sce,k="som100", cluster_id %in% c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20))
plotDR(u, color_by="som100")

u<-filterSCE(sce,k="som100", cluster_id %in% c(21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40))
plotDR(u, color_by="som100")

#load updated merging table and check that annotation is looking good so far
merging_table <-read.csv("merging_table.csv", header=T)
sce<-mergeClusters(sce, k="som100", table=merging_table, id="merging2")
plotDR(sce, color_by="merging2")

u<-filterSCE(sce,k="som100", cluster_id %in% c(41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60))
plotDR(u, color_by="som100")

u<-filterSCE(sce,k="som100", cluster_id %in% c(61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80))
plotDR(u, color_by="som100")

#load updated merging table and check that annotation is looking good so far
merging_table <-read.csv("merging_table.csv", header=T)
sce<-mergeClusters(sce, k="som100", table=merging_table, id="merging3")
plotDR(sce, color_by="merging3")

u<-filterSCE(sce,k="som100", cluster_id %in% c(81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100))
plotDR(u, color_by="som100")

merging_table <-read.csv("merging_table.csv", header=T)
sce<-mergeClusters(sce, k="som100", table=merging_table, id="merging4")
plotDR(sce, color_by="merging4")

#from this, I'm not completely happy with the unstained so will try to pull those apart a bit better

u<-filterSCE(sce,k="som100", cluster_id %in% c(31,32,33,41,42,43,44,51,52,53,54,55))
plotDR(u, color_by="som100")

merging_table <-read.csv("merging_table.csv", header=T)
sce<-mergeClusters(sce, k="som100", table=merging_table, id="merging5")
plotDR(sce, color_by="merging5")
```



we now need to change the colors slightly so that some populations stand out a bit better
```{r}
sce<-readRDS(file="cluster and UMAP_v2.rds")

#to identify what order the cluster are coded by
sce@metadata[["cluster_codes"]][["merging5"]]

#CATALYST colors
CATALYST:::.cluster_cols

plotDR(sce, color_by="B_cell_subsets", k_pal=c("#DC050C", "#3CB371", "#1965B0", "#7BAFDE", "#882E72", "#C71585", "#FF7F00", "#000080", "#808080", "#C0C0C0"))

```

```{r}

#let's save the annotated clusters
png(file="UMAP Annotated.png", width=1200, height=745)
plotDR(sce,color_by="merging5", k_pal=c("#DC050C", "#3CB371", "#1965B0", "#7BAFDE", "#882E72", "#C71585", "#FF7F00", "#000080", "#808080", "#C0C0C0")) +labs(title="Annotated clusters", )
dev.off()
```

```{r, echo=F, eval=F}
saveRDS(sce,file="cluster and UMAP_v2.rds")
```

time to make some graphs of the clusters

```{r}
plotExprHeatmap(sce, features="type", by="cluster_id", k="merging5", scale="first", q=0.01, perc=T, col_dend=F, bars=T)
plotClusterExprs(sce, k="merging5", features="type")
plotCodes(sce,k="merging5")
plotAbundances(sce, k="merging5", by="sample_id", group_by="condition")
plotAbundances(sce, k="merging5", by="cluster_id", group_by="condition")
plotDR(sce, color_by="merging5", facet_by="condition", k_pal=c("#DC050C", "#3CB371", "#1965B0", "#7BAFDE", "#882E72", "#C71585", "#FF7F00", "#000080", "#808080", "#C0C0C0"))
plotDR(sce, color_by="merging5", facet_by="patient_ID", k_pal=c("#DC050C", "#3CB371", "#1965B0", "#7BAFDE", "#882E72", "#C71585", "#FF7F00", "#000080", "#808080", "#C0C0C0"))
pbMDS(sce,by="both", k="merging5", shape_by="condition", size_by=T)
plotFreqHeatmap(sce, k = "merging5", row_anno = T, hm_pal = rev(hcl.colors(15, "RdBu")), k_pal = c("#DC050C", "#3CB371", "#1965B0", "#7BAFDE", "#882E72", "#C71585", "#FF7F00", "#000080", "#808080", "#C0C0C0"), bars = F, perc = F, col_anno="condition")
```

Time to make some stats on cluster abundance at the two states, first we need to change the levels so that data is separated by condition
```{r}
levels(sce$sample_id)
write.csv(levels(sce$sample_id), file="levels.csv")

#order this file in excel as per your preference

ordered<-read.csv("levels_edited.csv", sep=",")

ordered
ordered$name

sce$sample_id <- factor(sce$sample_id, levels = ordered$name)
levels(sce$sample_id)
```

Now we can proceed with analysis
```{r}
dir.create("Results")
ei <- metadata(sce)$experiment_info
(da_formula<-createFormula(ei, cols_fixed=c("condition"), cols_random=c("sample_id")))
contrast<-createContrast(c(0,1))
DA_res<- diffcyt(sce, formula = da_formula, contrast = contrast, analysis_type = "DA", method_DA = "diffcyt-DA-GLMM", clustering_to_use = "B_cell_subsets", verbose = T)

#display results
rowData(DA_res$res)
FDR_cutoff <- 0.05
table(rowData(DA_res$res)$p_adj < FDR_cutoff)

tbl_DA<-rowData(DA_res$res)
plotDiffHeatmap(sce, tbl_DA, all=T, fdr=0.05, col_anno="condition")
plotAbundances(sce, k="B_cell_subsets", by="cluster_id", group_by="condition")

write.csv(rowData(DA_res$res), file="Results/Acute vs Ctrl.csv")

#testing a paired analysis
(da_formula<-createFormula(ei, cols_fixed=c("condition"), cols_random=c("patient_ID", "sample_id")))
contrast<-createContrast(c(0,1))
DA_res_paired<- diffcyt(sce, formula = da_formula, contrast = contrast, analysis_type = "DA", method_DA = "diffcyt-DA-GLMM", clustering_to_use = "B_cell_subsets", verbose = T)

#display results
rowData(DA_res_paired$res)
FDR_cutoff <- 0.05
table(rowData(DA_res_paired$res)$p_adj < FDR_cutoff)

tbl_DA<-rowData(DA_res_paired$res)
plotDiffHeatmap(sce, tbl_DA, all=T, fdr=0.05, col_anno="condition")
plotAbundances(sce, k="B_cell_subsets", by="cluster_id", group_by="condition")

write.csv(rowData(DA_res$res), file="Results/Acute vs Ctrl.csv")

```

The data can also be used for "manual" analysis in another stats program, do do that we need to export cluster abundances
```{r}
abundances<-table(cluster_id=cluster_ids(sce,"merging5"), sample_id=sample_ids(sce))
write.csv(abundances, file="cluster abundance.csv")
```

This is some testing on how to export the data in sce so that it can be used to be more easily accessible
```{r}
abundances<-table(cluster_id=cluster_ids(sce,"merging5"), sample_id=sample_ids(sce))

heatmap(abundances, scale="row", Rowv=T, Colv=T, xlab="Patient ID", ylab="Cluster", main="Cluster abundance heatmap")

#this below is still work in progress
sce_data<-as.matrix(c(cluster_id=cluster_ids(sce,"merging5"), sample_id=sample_ids(sce), sce@metadata[["experiment_info"]][["condition"]]))

sce_data
head(sce_data)
```


## Session information

```{r}
sessionInfo()
```

